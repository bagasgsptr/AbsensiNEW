<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Absensi + QR & Barcode (Generator + Scanner)</title>

<!-- Libraries -->
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/JsBarcode/3.11.5/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
  :root{
    --bg:#0f172a; --card:#0b1224; --accent:#22d3ee; --accent-2:#a78bfa;
    --text:#e5e7eb; --text-dim:#94a3b8; --radius:14px; --shadow:0 8px 20px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',sans-serif;background:radial-gradient(900px 400px at 20% -10%, rgba(167,139,250,.08), transparent 60%),var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.04);margin-bottom:16px;overflow:hidden}
  .card-header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.04);display:flex;align-items:center;justify-content:space-between}
  .card-body{padding:14px 16px}
  .title{font-weight:700}
  label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:6px}
  input[type="text"], input[type="month"], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.06);background:#061122;color:var(--text);outline:none}
  textarea{resize:vertical}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:none;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#001018}
  .btn.sec{background:#111827;color:var(--text)}
  .btn.warn{background:linear-gradient(135deg,#f59e0b,#f43f5e);color:#170b03}
  .pill{padding:6px 10px;border-radius:999px;background:#06132a;color:var(--text-dim);font-size:12px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  thead th{font-size:12px;color:var(--text-dim);text-align:left;padding:8px 6px}
  tbody tr{background:linear-gradient(180deg,#071226,#03101a);border-radius:8px;margin-bottom:8px}
  td{padding:10px 6px;border-top:1px solid rgba(255,255,255,.03)}
  .status{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .Hadir{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25)}
  .Izin{background:rgba(245,158,11,.12);color:#fde68a;border:1px solid rgba(245,158,11,.25)}
  .Sakit{background:rgba(59,130,246,.12);color:#93c5fd;border:1px solid rgba(59,130,246,.25)}
  .Alfa{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25)}
  @media (min-width:720px){
    .flex-2{display:flex;gap:12px}
    .flex-2 > div{flex:1}
  }
  small.note{color:var(--text-dim);display:block;margin-top:8px}
  dialog{border:none;border-radius:12px;background:var(--card);color:var(--text);padding:0;max-width:640px;width:96vw}
  #qr-reader, #barcode-reader{width:100%;min-height:200px}
  .codes-wrap{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  .code-box{background:#061226;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.04)}
  .code-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="card-header">
      <div>
        <div class="title">Absensi + Generator QR & Barcode</div>
        <div style="font-size:12px;color:var(--text-dim)">Buat kode dari Nama+NPM dan scan menggunakan kamera HP</div>
      </div>
      <div class="pill" id="todayPill">...</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><strong>Form Identitas & Generator</strong></div>
    <div class="card-body">
      <label>Nama</label>
      <input id="nama" type="text" placeholder="Nama lengkap" autocomplete="name" />

      <label>NPM</label>
      <input id="npm" type="text" placeholder="2101020xxx" inputmode="numeric" />

      <div class="row" style="margin-top:8px">
        <button id="genCodes" class="btn">Buat QR & Barcode</button>
        <button id="clearPerson" class="btn sec">Kosongkan</button>
        <button id="downloadAll" class="btn sec">Download Semua Gambar</button>
        <div style="flex:1"></div>
        <button id="scanSelectBtn" class="btn sec">Mulai Scan (Pilih jenis)</button>
      </div>

      <small class="note">QR akan menyimpan JSON {"nama":"...","npm":"..."}; Barcode 1D menyimpan string NPM.</small>

      <div style="margin-top:12px" id="codesArea">
        <div class="codes-wrap">
          <!-- QR -->
          <div class="code-box" id="qrBox" style="display:none">
            <div><strong>QR Code</strong></div>
            <div id="qrcode"></div>
            <div class="code-actions">
              <button id="downloadQr" class="btn sec">Download QR</button>
              <button id="printQr" class="btn sec">Cetak</button>
            </div>
          </div>

          <!-- Barcode 1D -->
          <div class="code-box" id="barcodeBox" style="display:none">
            <div><strong>Barcode 1D (EAN / CODE128)</strong></div>
            <svg id="barcodeSvg"></svg>
            <canvas id="barcodeCanvas" style="display:none"></canvas>
            <div class="code-actions">
              <button id="downloadBarcode" class="btn sec">Download Barcode</button>
              <button id="printBarcode" class="btn sec">Cetak</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex-2">
    <div class="card">
      <div class="card-header"><strong>Scanner</strong></div>
      <div class="card-body">
        <div class="row" style="margin-bottom:8px">
          <button id="scanQrBtn" class="btn">Scan QR</button>
          <button id="scanBarcodeBtn" class="btn">Scan Barcode 1D</button>
          <button id="stopScanBtn" class="btn sec">Stop</button>
        </div>
        <div id="scannerStatus" style="color:var(--text-dim);margin-bottom:8px">Status: siap</div>
        <div id="qr-reader" style="display:none"></div>
        <div id="barcode-reader" style="display:none"></div>
        <small class="note">Gunakan kamera belakang (facingMode: environment). Jika error, cek izin kamera.</small>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><strong>Form Absensi</strong></div>
      <div class="card-body">
        <label>Tanggal</label>
        <input id="tanggal" type="text" disabled />
        <label>Waktu</label>
        <input id="waktu" type="text" disabled />
        <label>Status</label>
        <select id="status">
          <option value="Hadir">Hadir</option>
          <option value="Izin">Tidak Hadir</option>
          <option value="Sakit">Sakit</option>
          <option value="Alfa">Alfa</option>
        </select>
        <label style="margin-top:8px">Catatan</label>
        <textarea id="catatan" rows="2"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="saveAbs" class="btn">Simpan Absensi</button>
          <button id="exportCsv" class="btn sec">Ekspor CSV</button>
          <button id="exportJson" class="btn sec">Backup JSON</button>
        </div>
        <small class="note">Catatan: entri unik per Tanggal + NPM</small>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><strong>Riwayat Absensi</strong> <span class="pill" id="countRows">0 entri</span></div>
    <div class="card-body" style="overflow:auto">
      <table><thead><tr><th>Tanggal</th><th>Waktu</th><th>Nama / NPM</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr></thead>
      <tbody id="tbody"></tbody></table>
    </div>
  </div>
</div>

<!-- Dialog simple for scanning type choice not needed - buttons provided -->

<script>
/* ========== UTIL & STORAGE ========== */
const KEY = 'absensi_codes_v1';
const fmtID = new Intl.DateTimeFormat('id-ID',{ weekday:'long', day:'2-digit', month:'long', year:'numeric' });
const fmtTime = new Intl.DateTimeFormat('id-ID',{ hour:'2-digit', minute:'2-digit', second:'2-digit' });

function todayISO(){ const n=new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`; }
function nowFmt(){ const n=new Date(); return {disp: fmtID.format(n), time: fmtTime.format(n)}; }
function load(){ try{ return JSON.parse(localStorage.getItem(KEY))||[] }catch{ return [] } }
function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

/* set date/time on UI */
function setTodayFields(){ const now = nowFmt(); document.getElementById('tanggal').value = now.disp; document.getElementById('waktu').value = now.time; document.getElementById('todayPill').textContent = now.disp; }

/* ensure unique per date + npm */
function ensureUnique(data, rec){
  const key = rec.dateISO + '::' + rec.npm;
  const idx = data.findIndex(x=> (x.dateISO+'::'+x.npm) === key);
  if(idx>-1){ data[idx] = {...data[idx], ...rec, id: data[idx].id}; }
  else data.push(rec);
  return data;
}

/* render history */
function render(){
  const body = document.getElementById('tbody'); body.innerHTML='';
  const all = load().sort((a,b)=> a.dateISO<b.dateISO?1: a.dateISO>b.dateISO?-1:0);
  document.getElementById('countRows').textContent = `${all.length} entri`;
  all.forEach(r=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = r.dateDisp;
    const td2 = document.createElement('td'); td2.textContent = r.time;
    const td3 = document.createElement('td'); td3.innerHTML = `<strong>${r.nama||'-'}</strong><div style="font-size:12px;color:var(--text-dim)">${r.npm||''}</div>`;
    const td4 = document.createElement('td'); td4.innerHTML = `<span class="status ${r.status}">${r.status}</span>`;
    const td5 = document.createElement('td'); td5.textContent = r.note||'';
    const td6 = document.createElement('td');
    const btnDel = document.createElement('button'); btnDel.className='btn warn'; btnDel.textContent='Hapus';
    btnDel.addEventListener('click', ()=> { if(!confirm('Hapus entri?')) return; const filtered = load().filter(x=> x.id !== r.id); save(filtered); render(); });
    td6.appendChild(btnDel);
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5); tr.appendChild(td6);
    body.appendChild(tr);
  });
}

/* ========== GENERATOR ========== */
let qrcodeObj = null;
document.getElementById('genCodes').addEventListener('click', ()=>{
  const nama = document.getElementById('nama').value.trim();
  const npm = document.getElementById('npm').value.trim();
  if(!nama || !npm) return alert('Isi Nama & NPM terlebih dahulu.');

  // QR JSON
  const payload = JSON.stringify({nama, npm});
  const qrBox = document.getElementById('qrBox'); qrBox.style.display='block';
  const qrcodeContainer = document.getElementById('qrcode');
  qrcodeContainer.innerHTML = '';
  qrcodeObj = new QRCode(qrcodeContainer, { text: payload, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.H });

  // Barcode 1D (CODE128). Render to SVG via JsBarcode
  const barcodeBox = document.getElementById('barcodeBox'); barcodeBox.style.display='block';
  const svg = document.getElementById('barcodeSvg');
  // Clear svg content
  while(svg.firstChild) svg.removeChild(svg.firstChild);
  // JsBarcode accepts svg element directly:
  try{
    JsBarcode(svg, npm, {format: "CODE128", displayValue: true, fontSize:14, height:60, margin:8});
  }catch(e){
    console.error('JsBarcode error', e);
    alert('Gagal membuat barcode: '+ e.message);
  }
});

/* download helpers */
function downloadDataUrl(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl; a.download = filename; a.click();
}

/* download QR as PNG */
document.getElementById('downloadQr').addEventListener('click', ()=>{
  const qelm = document.querySelector('#qrcode img, #qrcode canvas');
  if(!qelm) return alert('QR belum dibuat.');
  // if img
  if(qelm.tagName.toLowerCase() === 'img'){
    downloadDataUrl(qelm.src, `qr_${document.getElementById('npm').value || 'code'}.png`);
  } else if(qelm.tagName.toLowerCase() === 'canvas'){
    downloadDataUrl(qelm.toDataURL('image/png'), `qr_${document.getElementById('npm').value || 'code'}.png`);
  }
});
document.getElementById('printQr').addEventListener('click', ()=>{
  const qelm = document.querySelector('#qrcode img, #qrcode canvas');
  if(!qelm) return alert('QR belum dibuat.');
  const w = window.open('','_blank'); w.document.write('<img src="'+ (qelm.tagName.toLowerCase()==='img'? qelm.src : qelm.toDataURL()) +'" />'); w.document.close(); w.print();
});

/* download Barcode (SVG -> PNG) */
document.getElementById('downloadBarcode').addEventListener('click', ()=>{
  const svg = document.getElementById('barcodeSvg');
  if(!svg) return alert('Barcode belum dibuat.');
  const serializer = new XMLSerializer();
  const svgStr = serializer.serializeToString(svg);
  const blob = new Blob([svgStr], {type:'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  // Convert to canvas then download
  const img = new Image();
  img.onload = function(){
    const canvas = document.createElement('canvas');
    canvas.width = img.width; canvas.height = img.height;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);
    const dataUrl = canvas.toDataURL('image/png');
    downloadDataUrl(dataUrl, `barcode_${document.getElementById('npm').value || 'code'}.png`);
    URL.revokeObjectURL(url);
  };
  img.src = url;
});
document.getElementById('printBarcode').addEventListener('click', ()=>{
  const svg = document.getElementById('barcodeSvg');
  if(!svg) return alert('Barcode belum dibuat.');
  const serializer = new XMLSerializer(); const svgStr = serializer.serializeToString(svg);
  const w = window.open('','_blank'); w.document.write(svgStr); w.document.close(); w.print();
});

/* download all images */
document.getElementById('downloadAll').addEventListener('click', async ()=>{
  // trigger both downloads (QR then Barcode)
  document.getElementById('downloadQr').click();
  // small delay then barcode
  setTimeout(()=> document.getElementById('downloadBarcode').click(), 600);
});

/* clear person fields */
document.getElementById('clearPerson').addEventListener('click', ()=>{ document.getElementById('nama').value=''; document.getElementById('npm').value=''; document.getElementById('qrcode').innerHTML=''; document.getElementById('barcodeSvg').innerHTML=''; document.getElementById('qrBox').style.display='none'; document.getElementById('barcodeBox').style.display='none'; });

/* ========== SCANNERS ========== */
let html5Scanner = null;
let quaggaRunning = false;

async function startQrScanner(){
  stopAllScanners();
  document.getElementById('qr-reader').style.display='block';
  document.getElementById('barcode-reader').style.display='none';
  document.getElementById('scannerStatus').textContent = 'Status: scanning QR...';
  html5Scanner = new Html5Qrcode("qr-reader");
  try{
    await html5Scanner.start({facingMode: "environment"}, {fps:10, qrbox: {width:250, height:250}}, (decoded)=>{
      // handle decoded -> expect JSON
      try{
        const data = JSON.parse(decoded);
        if(data.nama) document.getElementById('nama').value = String(data.nama);
        if(data.npm) document.getElementById('npm').value = String(data.npm);
        alert(`QR terbaca: ${data.nama || '-'} (${data.npm || '-'})`);
        stopAllScanners();
      }catch(e){
        alert('QR terbaca tapi bukan JSON. Isi: {"nama":"...","npm":"..."}');
      }
    }, (err)=>{/* frame errors ignored */});
  }catch(e){
    alert('Gagal memulai QR scanner: ' + (e.message||e));
    document.getElementById('scannerStatus').textContent = 'Status: error';
  }
}

function startBarcodeScanner(){
  stopAllScanners();
  document.getElementById('barcode-reader').style.display='block';
  document.getElementById('qr-reader').style.display='none';
  document.getElementById('scannerStatus').textContent = 'Status: scanning barcode...';
  // Quagga init
  Quagga.init({
    inputStream: {
      type: "LiveStream",
      constraints: { facingMode: "environment" },
      target: document.getElementById('barcode-reader'),
      area: { top: "20%", right: "10%", left: "10%", bottom: "20%" }
    },
    frequency: 10,
    decoder: {
      readers: ["code_128_reader","ean_reader","ean_8_reader","code_39_reader","upc_reader","upc_e_reader"]
    },
    locate: true
  }, function(err){
    if(err){ console.error(err); alert('Gagal memulai barcode scanner: '+ (err.message||err)); document.getElementById('scannerStatus').textContent='Status: error'; return; }
    Quagga.start();
    quaggaRunning = true;
    Quagga.onDetected(onBarcodeDetected);
  });
}
function onBarcodeDetected(result){
  if(!result || !result.codeResult || !result.codeResult.code) return;
  const code = result.codeResult.code;
  // write code into NPM field and attempt to autofill name? name unknown
  document.getElementById('npm').value = code;
  alert('Barcode terbaca: ' + code);
  stopAllScanners();
}

function stopAllScanners(){
  document.getElementById('qr-reader').style.display='none';
  document.getElementById('barcode-reader').style.display='none';
  document.getElementById('scannerStatus').textContent = 'Status: siap';
  // stop html5
  if(html5Scanner){
    html5Scanner.stop().then(()=> html5Scanner.clear()).catch(()=>{}).finally(()=> html5Scanner = null);
  }
  // stop quagga
  if(quaggaRunning){
    try{ Quagga.stop(); Quagga.offDetected(onBarcodeDetected); }catch(e){ console.warn(e); }
    quaggaRunning = false;
  }
}

/* scanner buttons */
document.getElementById('scanQrBtn').addEventListener('click', ()=> startQrScanner());
document.getElementById('scanBarcodeBtn').addEventListener('click', ()=> startBarcodeScanner());
document.getElementById('stopScanBtn').addEventListener('click', ()=> stopAllScanners());

/* ========== SAVE ABSENSI ========== */
document.getElementById('saveAbs').addEventListener('click', ()=>{
  const nama = document.getElementById('nama').value.trim();
  const npm = document.getElementById('npm').value.trim();
  if(!nama || !npm) return alert('Isi Nama & NPM (atau scan) sebelum menyimpan.');
  const status = document.getElementById('status').value;
  const note = document.getElementById('catatan').value.trim();
  const now = nowFmt();
  const rec = {
    id: uid(),
    dateISO: todayISO(),
    dateDisp: now.disp,
    time: now.time,
    nama, npm, status, note
  };
  const data = ensureUnique(load(), rec);
  save(data);
  render();
  alert('Absensi tersimpan.');
});

/* exports */
function toCSV(rows){
  const header = ['Tanggal','Waktu','Nama','NPM','Status','Catatan'];
  const lines = rows.map(r=> [r.dateDisp, r.time, r.nama||'', r.npm||'', r.status, (r.note||'').replace(/\n/g,' ')].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(','));
  return [header.join(','), ...lines].join('\n');
}
document.getElementById('exportCsv').addEventListener('click', ()=>{
  const csv = toCSV(load());
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'absensi.csv'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('exportJson').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(load(), null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'absensi_backup.json'; a.click(); URL.revokeObjectURL(a.href);
});

/* init */
setTodayFields();
render();
/* refresh time display */
setInterval(()=> setTodayFields(), 1000);

/* cleanup when leaving page */
window.addEventListener('beforeunload', ()=> stopAllScanners());
</script>
</body>
</html>
