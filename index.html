<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Absensi Wajah Web</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
<style>
  * { scrollbar-width: thin; }
  .btn { @apply px-4 py-2 rounded-2xl shadow text-white transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed; }
  .btn-primary { @apply bg-indigo-600 hover:bg-indigo-500; }
  .btn-danger { @apply bg-rose-600 hover:bg-rose-500; }
  .btn-secondary { @apply bg-slate-700 hover:bg-slate-600; }
  .card { @apply bg-white rounded-2xl shadow-lg p-4 transition hover:shadow-xl; }
  .chip { @apply inline-flex items-center gap-2 text-xs font-medium px-3 py-1 rounded-full bg-slate-100; }
  .toast { @apply fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-2 rounded-2xl shadow-lg opacity-0 pointer-events-none transition-opacity; }
  .toast.show { opacity: 1; pointer-events-auto; }
  #vid-enroll, #vid-absen { aspect-ratio: 4/3; object-fit: cover; border-radius: 1rem; }
  canvas { border-radius: 1rem; }
</style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">

<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <span class="w-9 h-9 grid place-items-center rounded-2xl bg-indigo-600 text-white font-bold">AW</span>
      <h1 class="text-lg font-semibold">Absensi Wajah</h1>
    </div>
    <nav class="flex gap-2">
      <button id="tab-admin" class="btn btn-secondary">Admin</button>
      <button id="tab-absen" class="btn btn-primary">Mahasiswa</button>
      <button id="tab-setting" class="btn btn-secondary">Pengaturan</button>
    </nav>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 grid gap-4">
  <!-- Panel info -->
  <section class="grid lg:grid-cols-3 gap-4">
    <div class="card col-span-2">
      <h2 class="text-xl font-semibold">Status Model</h2>
      <div id="modelStatus" class="mt-2 text-sm text-slate-600">Menunggu inisialisasi...</div>
      <div class="mt-3 h-2 bg-slate-200 rounded-full overflow-hidden">
        <div id="modelProgress" class="h-full w-0 bg-indigo-500 transition-all"></div>
      </div>
      <div class="mt-3 text-xs text-slate-500">Model diambil dari CDN: <code>@vladmandic/face-api</code></div>
    </div>
    <div class="card">
      <h2 class="text-xl font-semibold">Ringkas Data</h2>
      <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
        <div class="chip">Terdaftar: <span id="statRegistered" class="font-semibold">0</span></div>
        <div class="chip">Absensi: <span id="statAttendance" class="font-semibold">0</span></div>
      </div>
      <div class="mt-4 flex gap-2 flex-wrap">
        <button id="btn-export-json" class="btn btn-secondary">Export Data (.json)</button>
        <label class="btn btn-secondary cursor-pointer">
          Import Data<input id="file-import-json" type="file" accept="application/json" class="hidden" />
        </label>
      </div>
    </div>
  </section>

  <!-- Admin -->
  <section id="view-admin" class="grid lg:grid-cols-5 gap-4">
    <div class="card lg:col-span-2">
      <h3 class="text-lg font-semibold">Daftarkan Mahasiswa</h3>
      <p class="text-sm text-slate-600">Isi identitas lalu ambil beberapa contoh wajah.</p>
      <div class="mt-3 grid gap-2">
        <input id="in-nama" class="border rounded-xl px-3 py-2" placeholder="Nama lengkap" />
        <input id="in-npm" class="border rounded-xl px-3 py-2" placeholder="NPM" />
      </div>
      <div class="mt-3 grid gap-3">
        <div class="grid sm:grid-cols-2 gap-3">
          <button id="btn-start-enroll" class="btn btn-primary">Mulai Kamera</button>
          <button id="btn-stop-enroll" class="btn btn-danger">Matikan Kamera</button>
        </div>
        <div class="text-sm text-slate-600">Target contoh: <span id="sampleTarget">5</span> · Terkumpul: <span id="sampleCount">0</span></div>
        <div class="h-2 bg-slate-200 rounded-full overflow-hidden"><div id="enrollProgress" class="h-full w-0 bg-emerald-500 transition-all"></div></div>
        <div class="grid sm:grid-cols-2 gap-3">
          <button id="btn-capture" class="btn btn-secondary">Ambil Contoh</button>
          <button id="btn-save-student" class="btn btn-primary">Simpan Mahasiswa</button>
        </div>
      </div>
      <div class="mt-4 relative">
        <video id="vid-enroll" autoplay muted playsinline class="w-full rounded-xl border"></video>
        <canvas id="cv-enroll" class="absolute inset-0 pointer-events-none"></canvas>
      </div>
      <div class="mt-2 grid grid-cols-5 gap-2" id="thumbs"></div>
    </div>

    <div class="card lg:col-span-3">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Mahasiswa Terdaftar</h3>
        <input id="search-student" class="border rounded-xl px-3 py-2" placeholder="Cari nama / NPM" />
      </div>
      <div class="mt-3 overflow-auto max-h-[480px]">
        <table class="w-full text-sm">
          <thead class="bg-slate-100 sticky top-0">
            <tr>
              <th class="text-left p-2">Nama</th>
              <th class="text-left p-2">NPM</th>
              <th class="text-left p-2">Contoh Wajah</th>
              <th class="text-left p-2">Aksi</th>
            </tr>
          </thead>
          <tbody id="tbl-students"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Mahasiswa / Absensi -->
  <section id="view-absen" class="grid lg:grid-cols-5 gap-4 hidden">
    <div class="card lg:col-span-3">
      <h3 class="text-lg font-semibold">Kamera Absensi</h3>
      <div class="relative mt-3">
        <video id="vid-absen" autoplay muted playsinline class="w-full rounded-xl border"></video>
        <canvas id="ov-absen" class="absolute inset-0 pointer-events-none"></canvas>
      </div>
      <div class="mt-3 flex flex-wrap gap-2 items-center">
        <button id="btn-start-absen" class="btn btn-primary">Mulai Kamera</button>
        <button id="btn-stop-absen" class="btn btn-danger">Matikan Kamera</button>
        <button id="btn-once-absen" class="btn btn-secondary">Scan Sekali</button>
        <span id="matchInfo" class="chip">Hasil: -</span>
      </div>
      <div id="absenAlert" class="mt-3 hidden p-3 rounded-xl border"></div>
    </div>
    <div class="card lg:col-span-2">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Riwayat Absensi</h3>
        <div class="flex gap-2">
          <button id="btn-export-csv" class="btn btn-secondary">Export CSV</button>
          <button id="btn-clear-att" class="btn btn-danger">Bersihkan</button>
        </div>
      </div>
      <div class="mt-2 h-72 overflow-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-100 sticky top-0">
            <tr>
              <th class="text-left p-2">Waktu</th>
              <th class="text-left p-2">Nama</th>
              <th class="text-left p-2">NPM</th>
            </tr>
          </thead>
          <tbody id="tbl-att"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Pengaturan -->
  <section id="view-setting" class="grid lg:grid-cols-3 gap-4 hidden">
    <div class="card">
      <h3 class="text-lg font-semibold">Pengenalan Wajah</h3>
      <label class="block mt-3 text-sm">Ambang (threshold) kecocokan: <span id="txt-threshold" class="font-semibold"></span></label>
      <input id="in-threshold" type="range" min="0.3" max="0.8" step="0.01" class="w-full" />
      <p class="text-xs text-slate-500 mt-1">Semakin kecil nilai ambang, semakin ketat kecocokannya.</p>
      <div class="mt-3 grid sm:grid-cols-2 gap-2">
        <button id="btn-rebuild" class="btn btn-secondary">Bangun Ulang Index</button>
        <button id="btn-clear-all" class="btn btn-danger">Hapus Semua Data</button>
      </div>
    </div>
    <div class="card lg:col-span-2">
      <h3 class="text-lg font-semibold">Catatan & Tips</h3>
      <ul class="list-disc pl-6 text-sm text-slate-600 mt-2">
        <li>Ambil minimal 5 contoh wajah untuk tiap mahasiswa.</li>
        <li>Gunakan pencahayaan cukup, kamera menghadap wajah lurus.</li>
        <li>Jika akurasi kurang, turunkan threshold atau tambah contoh wajah.</li>
        <li>Data saat ini disimpan di browser (localStorage). Untuk produksi, gunakan backend & database.</li>
      </ul>
    </div>
  </section>
</main>

<footer class="text-center text-xs text-slate-500 py-6">Frontend demo • face-api.js • Tanpa backend</footer>

<div id="toast" class="toast"></div>

<script>
const STORE = { studentsKey: 'aw.students.v1', attendKey: 'aw.attendance.v1', settingKey: 'aw.settings.v1' };
let students = JSON.parse(localStorage.getItem(STORE.studentsKey)||'[]');
let attendance = JSON.parse(localStorage.getItem(STORE.attendKey)||'[]');
let settings = JSON.parse(localStorage.getItem(STORE.settingKey)||'{"threshold":0.5,"sampleTarget":5}');

function save(key,val){ localStorage.setItem(key,JSON.stringify(val)); }
function E(id){ return document.getElementById(id); }

const modelStatus=E('modelStatus'), modelProgress=E('modelProgress');
const statRegistered=E('statRegistered'), statAttendance=E('statAttendance');
const vidEnroll=E('vid-enroll'), cvEnroll=E('cv-enroll'), thumbs=E('thumbs');
const sampleTargetEl=E('sampleTarget'), sampleCountEl=E('sampleCount'), enrollProgress=E('enrollProgress');
const vidAbsen=E('vid-absen'), ovAbsen=E('ov-absen'), absenAlert=E('absenAlert'), matchInfo=E('matchInfo');
const inThreshold=E('in-threshold'), txtThreshold=E('txt-threshold');

let enrollSamples=[], faceMatcher=null;

function toast(msg,ok=true){
  const t=E('toast'); t.textContent=msg; t.className='toast show '+(ok?'bg-emerald-600':'bg-rose-600');
  setTimeout(()=> t.className='toast',3500);
}

function showView(name){
  E('view-admin').classList.toggle('hidden',name!=='admin');
  E('view-absen').classList.toggle('hidden',name!=='absen');
  E('view-setting').classList.toggle('hidden',name!=='setting');
}
E('tab-admin').onclick=()=>showView('admin');
E('tab-absen').onclick=()=>showView('absen');
E('tab-setting').onclick=()=>showView('setting');

async function loadModels(){
  const base='https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
  const list=[faceapi.nets.tinyFaceDetector, faceapi.nets.faceLandmark68Net, faceapi.nets.faceRecognitionNet];
  modelStatus.textContent='Mengunduh model...';
  for(let i=0;i<list.length;i++){
    modelProgress.style.width=Math.round((i/list.length)*100)+'%';
    await list[i].loadFromUri(base);
  }
  modelProgress.style.width='100%';
  modelStatus.textContent='Model siap.';
}

async function startStream(videoEl){
  if(videoEl.srcObject) return;
  try{ const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false}); videoEl.srcObject=stream; await videoEl.play(); }catch(err){ alert('Tidak bisa akses kamera'); }
}
function stopStream(videoEl){ videoEl.srcObject?.getTracks().forEach(t=>t.stop()); videoEl.srcObject=null; }

function renderStudents(){
  const tbl=E('tbl-students'); tbl.innerHTML='';
  const filter=E('search-student').value.toLowerCase();
  for(const s of students){
    if(s.nama.toLowerCase().includes(filter)||s.npm.toLowerCase().includes(filter)){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="p-2">${s.nama}</td><td class="p-2">${s.npm}</td>
      <td class="p-2">${s.samples.length}</td>
      <td class="p-2"><button class="btn btn-danger text-xs" onclick="deleteStudent('${s.npm}')">Hapus</button></td>`;
      tbl.appendChild(tr);
    }
  }
  statRegistered.textContent=students.length;
}
function deleteStudent(npm){ if(confirm('Hapus mahasiswa?')){ students=students.filter(s=>s.npm!==npm); save(STORE.studentsKey,students); renderStudents(); toast('Dihapus'); buildMatcher(); } }

function updateThumbs(){ thumbs.innerHTML=''; enrollSamples.forEach(s=>{ const img=document.createElement('img'); img.src=s; img.className='rounded-xl border'; img.width=50; img.height=50; thumbs.appendChild(img); }); sampleCountEl.textContent=enrollSamples.length; enrollProgress.style.width=(enrollSamples.length/settings.sampleTarget*100)+'%'; }

E('btn-start-enroll').onclick=()=>startStream(vidEnroll);
E('btn-stop-enroll').onclick=()=>stopStream(vidEnroll);
E('btn-capture').onclick=async()=>{
  if(!vidEnroll.srcObject){ toast('Kamera belum aktif',0); return; }
  const detections = await faceapi.detectSingleFace(vidEnroll,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  if(!detections){ toast('Wajah tidak terdeteksi',0); return; }
  const canvas=document.createElement('canvas'); canvas.width=vidEnroll.videoWidth; canvas.height=vidEnroll.videoHeight; canvas.getContext('2d').drawImage(vidEnroll,0,0);
  enrollSamples.push(canvas.toDataURL('image/jpeg')); updateThumbs();
  if(enrollSamples.length>=settings.sampleTarget) toast('Target contoh tercapai');
};

E('btn-save-student').onclick=async()=>{
  const nama=E('in-nama').value.trim(), npm=E('in-npm').value.trim();
  if(!nama||!npm||enrollSamples.length<settings.sampleTarget){ toast('Lengkapi data & ambil cukup contoh',0); return; }
  students.push({nama,npm,samples:enrollSamples}); save(STORE.studentsKey,students);
  enrollSamples=[]; updateThumbs(); E('in-nama').value=''; E('in-npm').value=''; toast('Mahasiswa disimpan');
  renderStudents(); buildMatcher();
};

E('search-student').oninput=renderStudents;

function buildMatcher(){
  const labeledDescriptors = students.map(s=>{
    const descs=s.samples.map(imgData=>{
      const img=new Image(); img.src=imgData;
      const det=faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
      return det.descriptor||new Float32Array(128);
    });
    return new faceapi.LabeledFaceDescriptors(s.npm, descs);
  });
  faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, settings.threshold);
}

E('btn-start-absen').onclick=()=>startStream(vidAbsen);
E('btn-stop-absen').onclick=()=>stopStream(vidAbsen);
E('btn-once-absen').onclick=async()=>{
  if(!vidAbsen.srcObject){ toast('Kamera belum aktif',0); return; }
  const det = await faceapi.detectSingleFace(vidAbsen,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  if(!det){ toast('Wajah tidak terdeteksi',0); return; }
  const bestMatch = faceMatcher.findBestMatch(det.descriptor);
  matchInfo.textContent='Hasil: '+bestMatch.toString();
  if(bestMatch.label!=='unknown'){
    const s=students.find(st=>st.npm===bestMatch.label);
    attendance.push({waktu:new Date().toLocaleString(),nama:s.nama,npm:s.npm});
    save(STORE.attendKey,attendance); renderAttendance();
    toast('Absensi berhasil');
  }else toast('Tidak terdaftar',0);
};

function renderAttendance(){
  const tbl=E('tbl-att'); tbl.innerHTML='';
  attendance.forEach(a=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td class="p-2">${a.waktu}</td><td class="p-2">${a.nama}</td><td class="p-2">${a.npm}</td>`;
    tbl.appendChild(tr);
  });
  statAttendance.textContent=attendance.length;
}
E('btn-clear-att').onclick=()=>{ if(confirm('Hapus semua absensi?')){ attendance=[]; save(STORE.attendKey,attendance); renderAttendance(); toast('Riwayat kosong'); }};

inThreshold.value=settings.threshold; txtThreshold.textContent=settings.threshold;
inThreshold.oninput=()=>{ settings.threshold=parseFloat(inThreshold.value); txtThreshold.textContent=settings.threshold; save(STORE.settingKey,settings); buildMatcher(); };

E('btn-export-json').onclick=()=>{ const data={students,attendance,settings}; const blob=new Blob([JSON.stringify(data)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='absensi.json'; a.click(); };

E('file-import-json').onchange=async(e)=>{
  const file=e.target.files[0]; if(!file) return;
  const text=await file.text(); try{ const obj=JSON.parse(text); students=obj.students||[]; attendance=obj.attendance||[]; settings=obj.settings||settings; save(STORE.studentsKey,students); save(STORE.attendKey,attendance); save(STORE.settingKey,settings); toast('Data diimport'); renderStudents(); renderAttendance(); buildMatcher(); }catch{ toast('File salah',0); }
};

E('btn-export-csv').onclick=()=>{
  const csv=[['Waktu','Nama','NPM'],...attendance.map(a=>[a.waktu,a.nama,a.npm])].map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='absensi.csv'; a.click();
};

E('btn-clear-all').onclick=()=>{ if(confirm('Hapus semua data mahasiswa?')){ students=[]; attendance=[]; save(STORE.studentsKey,students); save(STORE.attendKey,attendance); renderStudents(); renderAttendance(); buildMatcher(); toast('Semua data dihapus'); }};

window.onload=async()=>{ await loadModels(); renderStudents(); renderAttendance(); buildMatcher(); };
</script>
</body>
</html>
