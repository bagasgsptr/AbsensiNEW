<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absensi Wajah Keren</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Face API -->
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  <style>
    /* Scrollbar halus */
    * { scrollbar-width: thin; }
    .btn { @apply px-4 py-2 rounded-2xl shadow text-white transition active:scale-95; }
    .btn-primary { @apply bg-indigo-600 hover:bg-indigo-500; }
    .btn-danger { @apply bg-rose-600 hover:bg-rose-500; }
    .btn-secondary { @apply bg-slate-700 hover:bg-slate-600; }
    .card { @apply bg-white rounded-2xl shadow-lg p-4; }
    .chip { @apply inline-flex items-center gap-2 text-xs font-medium px-3 py-1 rounded-full bg-slate-100; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- Navbar -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="w-9 h-9 grid place-items-center rounded-2xl bg-indigo-600 text-white font-bold">AW</span>
        <h1 class="text-lg font-semibold">Absensi Wajah</h1>
      </div>
      <nav class="flex gap-2">
        <button id="tab-admin" class="btn btn-secondary">Admin</button>
        <button id="tab-absen" class="btn btn-primary">Mahasiswa</button>
        <button id="tab-setting" class="btn btn-secondary">Pengaturan</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 grid gap-4">
    <!-- Papan info -->
    <section class="grid lg:grid-cols-3 gap-4">
      <div class="card col-span-2">
        <h2 class="text-xl font-semibold">Status Model</h2>
        <div id="modelStatus" class="mt-2 text-sm text-slate-600">Menunggu inisialisasi...</div>
        <div class="mt-3 h-2 bg-slate-200 rounded-full overflow-hidden">
          <div id="modelProgress" class="h-full w-0 bg-indigo-500 transition-all"></div>
        </div>
        <div class="mt-3 text-xs text-slate-500">Model diambil dari CDN: <code>@vladmandic/face-api</code></div>
      </div>
      <div class="card">
        <h2 class="text-xl font-semibold">Ringkas Data</h2>
        <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
          <div class="chip">Terdaftar: <span id="statRegistered" class="font-semibold">0</span></div>
          <div class="chip">Absensi: <span id="statAttendance" class="font-semibold">0</span></div>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="btn-export-json" class="btn btn-secondary">Export Data (.json)</button>
          <label class="btn btn-secondary cursor-pointer">
            Import Data<input id="file-import-json" type="file" accept="application/json" class="hidden" />
          </label>
        </div>
      </div>
    </section>

    <!-- Konten: Admin -->
    <section id="view-admin" class="grid lg:grid-cols-5 gap-4 hidden">
      <div class="card lg:col-span-2">
        <h3 class="text-lg font-semibold">Daftarkan Mahasiswa</h3>
        <p class="text-sm text-slate-600">Isi identitas lalu ambil beberapa contoh wajah untuk meningkatkan akurasi.</p>
        <div class="mt-3 grid gap-2">
          <input id="in-nama" class="border rounded-xl px-3 py-2" placeholder="Nama lengkap" />
          <input id="in-npm" class="border rounded-xl px-3 py-2" placeholder="NPM" />
        </div>
        <div class="mt-3 grid gap-3">
          <div class="grid sm:grid-cols-2 gap-3">
            <button id="btn-start-enroll" class="btn btn-primary">Mulai Kamera</button>
            <button id="btn-stop-enroll" class="btn btn-danger">Matikan Kamera</button>
          </div>
          <div class="text-sm text-slate-600">Target contoh: <span id="sampleTarget">5</span> · Terkumpul: <span id="sampleCount">0</span></div>
          <div class="h-2 bg-slate-200 rounded-full overflow-hidden"><div id="enrollProgress" class="h-full w-0 bg-emerald-500 transition-all"></div></div>
          <div class="grid sm:grid-cols-2 gap-3">
            <button id="btn-capture" class="btn btn-secondary">Ambil Contoh</button>
            <button id="btn-save-student" class="btn btn-primary">Simpan Mahasiswa</button>
          </div>
        </div>
        <div class="mt-4">
          <video id="vid-enroll" autoplay muted playsinline class="w-full rounded-xl border"></video>
          <canvas id="cv-enroll" class="hidden"></canvas>
        </div>
        <div class="mt-2 grid grid-cols-5 gap-2" id="thumbs"></div>
      </div>

      <div class="card lg:col-span-3">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Mahasiswa Terdaftar</h3>
          <input id="search-student" class="border rounded-xl px-3 py-2" placeholder="Cari nama / NPM" />
        </div>
        <div class="mt-3 overflow-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr>
                <th class="text-left p-2">Nama</th>
                <th class="text-left p-2">NPM</th>
                <th class="text-left p-2">Contoh Wajah</th>
                <th class="text-left p-2">Aksi</th>
              </tr>
            </thead>
            <tbody id="tbl-students"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Konten: Mahasiswa / Absensi -->
    <section id="view-absen" class="grid lg:grid-cols-5 gap-4">
      <div class="card lg:col-span-3">
        <h3 class="text-lg font-semibold">Kamera Absensi</h3>
        <div class="relative mt-3">
          <video id="vid-absen" autoplay muted playsinline class="w-full rounded-xl border"></video>
          <canvas id="ov-absen" class="absolute inset-0"></canvas>
        </div>
        <div class="mt-3 flex flex-wrap gap-2 items-center">
          <button id="btn-start-absen" class="btn btn-primary">Mulai Kamera</button>
          <button id="btn-stop-absen" class="btn btn-danger">Matikan Kamera</button>
          <button id="btn-once-absen" class="btn btn-secondary">Scan Sekali</button>
          <span id="matchInfo" class="chip">Hasil: -</span>
        </div>
        <div id="absenAlert" class="mt-3 hidden p-3 rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-700"></div>
      </div>
      <div class="card lg:col-span-2">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Riwayat Absensi</h3>
          <div class="flex gap-2">
            <button id="btn-export-csv" class="btn btn-secondary">Export CSV</button>
            <button id="btn-clear-att" class="btn btn-danger">Bersihkan</button>
          </div>
        </div>
        <div class="mt-2 h-72 overflow-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr>
                <th class="text-left p-2">Waktu</th>
                <th class="text-left p-2">Nama</th>
                <th class="text-left p-2">NPM</th>
              </tr>
            </thead>
            <tbody id="tbl-att"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Konten: Pengaturan -->
    <section id="view-setting" class="grid lg:grid-cols-3 gap-4 hidden">
      <div class="card">
        <h3 class="text-lg font-semibold">Pengenalan Wajah</h3>
        <label class="block mt-3 text-sm">Ambang (threshold) kecocokan: <span id="txt-threshold" class="font-semibold"></span></label>
        <input id="in-threshold" type="range" min="0.3" max="0.8" step="0.01" class="w-full" />
        <p class="text-xs text-slate-500 mt-1">Semakin kecil nilai ambang, semakin ketat kecocokannya (lebih sedikit false positive).</p>
        <div class="mt-3 grid sm:grid-cols-2 gap-2">
          <button id="btn-rebuild" class="btn btn-secondary">Bangun Ulang Index</button>
          <button id="btn-clear-all" class="btn btn-danger">Hapus Semua Data</button>
        </div>
      </div>

      <div class="card lg:col-span-2">
        <h3 class="text-lg font-semibold">Catatan & Tips</h3>
        <ul class="list-disc pl-6 text-sm text-slate-600 mt-2">
          <li>Ambil minimal 5 contoh wajah untuk tiap mahasiswa (berbeda sudut dan ekspresi).</li>
          <li>Gunakan pencahayaan cukup, kamera menghadap wajah lurus.</li>
          <li>Jika akurasi kurang, turunkan threshold atau tambah contoh wajah.</li>
          <li>Data saat ini disimpan di browser (localStorage). Untuk produksi, gunakan backend & database.</li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-slate-500 py-6">Frontend demo • face-api.js • Tanpa backend</footer>

<script>
// ======= Password Admin =======
const ADMIN_PASSWORD = 'admin123';
let adminUnlocked = false;

// ======= Penyimpanan =======
const STORE = {
  studentsKey: 'aw.students.v1',
  attendKey: 'aw.attendance.v1',
  settingKey: 'aw.settings.v1'
};
let students = load(STORE.studentsKey, []);
let attendance = load(STORE.attendKey, []);
let settings = load(STORE.settingKey, { threshold: 0.5, sampleTarget: 5 });

function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; } }

// ======= Elemen =======
const E = (id) => document.getElementById(id);
const modelStatus = E('modelStatus');
const modelProgress = E('modelProgress');
const statRegistered = E('statRegistered');
const statAttendance = E('statAttendance');
const inThreshold = E('in-threshold');
const txtThreshold = E('txt-threshold');

const vidEnroll = E('vid-enroll');
const cvEnroll = E('cv-enroll');
const thumbs = E('thumbs');
const sampleTargetEl = E('sampleTarget');
const sampleCountEl = E('sampleCount');
const enrollProgress = E('enrollProgress');

const vidAbsen = E('vid-absen');
const ovAbsen = E('ov-absen');
const absenAlert = E('absenAlert');
const matchInfo = E('matchInfo');

let enrollSamples = [];
let faceMatcher = null;

// ======= Navigasi Tab =======
E('tab-admin').onclick = () => {
  if(!adminUnlocked){
    const pw = prompt('Masukkan password admin:');
    if(pw === ADMIN_PASSWORD){
      adminUnlocked = true;
      showView('admin');
    } else {
      alert('Password salah!');
      return;
    }
  } else {
    showView('admin');
  }
};
E('tab-absen').onclick = () => showView('absen');
E('tab-setting').onclick = () => showView('setting');

function showView(name){
  E('view-admin').classList.toggle('hidden', name!== 'admin');
  E('view-absen').classList.toggle('hidden', name!== 'absen');
  E('view-setting').classList.toggle('hidden', name!== 'setting');
}

// ======= Init =======
(async function init(){
  sampleTargetEl.textContent = settings.sampleTarget;
  inThreshold.value = settings.threshold;
  txtThreshold.textContent = settings.threshold.toFixed(2);
  refreshStats();
  renderStudents();
  renderAttendance();
  await loadModels();
  rebuildIndex();
  showView('absen');
})();

// ======= Model =======
async function loadModels(){
  const base = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
  const list = [
    faceapi.nets.tinyFaceDetector,
    faceapi.nets.faceLandmark68Net,
    faceapi.nets.faceRecognitionNet
  ];
  modelStatus.textContent = 'Mengunduh model...';
  for(let i=0;i<list.length;i++){
    const p = Math.round((i/list.length)*100);
    modelProgress.style.width = p + '%';
    await list[i].loadFromUri(base);
  }
  modelProgress.style.width = '100%';
  modelStatus.textContent = 'Model siap.';
}

// ======= Kamera =======
async function startStream(videoEl){
  if(videoEl.srcObject) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    videoEl.srcObject = stream;
    await videoEl.play();
  }catch(err){ alert('Tidak bisa mengakses kamera: '+ err.message); }
}
function stopStream(videoEl){
  const s = videoEl.srcObject; if(!s) return;
  s.getTracks().forEach(t=>t.stop());
  videoEl.srcObject = null;
}

// ======= Enroll / Admin =======
E('btn-start-enroll').onclick = ()=> startStream(vidEnroll);
E('btn-stop-enroll').onclick = ()=> stopStream(vidEnroll);
E('btn-capture').onclick = captureSample;
E('btn-save-student').onclick = saveStudent;
E('search-student').oninput = renderStudents;

async function captureSample(){
  if(!vidEnroll.srcObject){ alert('Nyalakan kamera dulu.'); return; }
  const det = await faceapi.detectSingleFace(vidEnroll, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  if(!det){ alert('Wajah tidak terdeteksi, coba posisikan wajah di tengah, cahaya cukup.'); return; }
  enrollSamples.push(det.descriptor);
  sampleCountEl.textContent = enrollSamples.length;
  enrollProgress.style.width = Math.min(100, (enrollSamples.length / settings.sampleTarget) * 100) + '%';
  const thumb = await snapshotFace(vidEnroll, det.detection.box);
  const img = new Image(); img.src = thumb; img.className = 'w-full rounded-lg border';
  const wrap = document.createElement('div'); wrap.className = 'rounded-lg overflow-hidden border'; wrap.appendChild(img);
  thumbs.appendChild(wrap);
}

async function snapshotFace(videoEl, box){
  const c = document.createElement('canvas');
  const size = 128; c.width = size; c.height = size;
  const ctx = c.getContext('2d');
  const sx = Math.max(0, box.x - box.width*0.2);
  const sy = Math.max(0, box.y - box.height*0.2);
  const sw = Math.min(videoEl.videoWidth - sx, box.width*1.4);
  const sh = Math.min(videoEl.videoHeight - sy, box.height*1.4);
  ctx.drawImage(videoEl, sx, sy, sw, sh, 0, 0, size, size);
  return c.toDataURL('image/jpeg', 0.7);
}

function resetEnrollUI(){
  enrollSamples = [];
  sampleCountEl.textContent = '0';
  enrollProgress.style.width = '0%';
  thumbs.innerHTML = '';
  E('in-nama').value = '';
  E('in-npm').value = '';
}

function saveStudent(){
  const nama = E('in-nama').value.trim();
  const npm = E('in-npm').value.trim();
  if(!nama || !npm){ alert('Nama & NPM wajib diisi.'); return; }
  if(enrollSamples.length < 1){ alert('Ambil minimal 1 contoh wajah (disarankan 5).'); return; }
  const existingIdx = students.findIndex(s=> s.npm === npm);
  const pack = enrollSamples.map(f => Array.from(f));
  if(existingIdx >= 0){
    students[existingIdx].nama = nama;
    students[existingIdx].descriptors = students[existingIdx].descriptors.concat(pack);
  } else {
    students.push({ nama, npm, descriptors: pack });
  }
  save(STORE.studentsKey, students);
  rebuildIndex();
  renderStudents();
  resetEnrollUI();
  alert('Mahasiswa tersimpan.');
}

// ======= Face Matcher =======
function rebuildIndex(){
  const labeled = students.map(s => new faceapi.LabeledFaceDescriptors(s.npm, s.descriptors.map(d => new Float32Array(d))));
  faceMatcher = new faceapi.FaceMatcher(labeled, settings.threshold);
}

// ======= Render =======
function renderStudents(){
  const filter = E('search-student').value.toLowerCase();
  const tbody = E('tbl-students'); tbody.innerHTML = '';
  students.filter(s => s.nama.toLowerCase().includes(filter) || s.npm.includes(filter))
    .forEach(s=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="p-2">${s.nama}</td><td class="p-2">${s.npm}</td><td class="p-2">${s.descriptors.length}</td><td class="p-2"><button class="btn btn-danger text-xs" onclick="deleteStudent('${s.npm}')">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
  refreshStats();
}

function deleteStudent(npm){
  if(!confirm('Hapus mahasiswa ini?')) return;
  students = students.filter(s=> s.npm!==npm);
  save(STORE.studentsKey, students);
  rebuildIndex();
  renderStudents();
}

function refreshStats(){
  statRegistered.textContent = students.length;
  statAttendance.textContent = attendance.length;
}

function renderAttendance(){
  const tbody = E('tbl-att'); tbody.innerHTML = '';
  attendance.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${a.time}</td><td class="p-2">${a.nama}</td><td class="p-2">${a.npm}</td>`;
    tbody.appendChild(tr);
  });
}

// ======= Absensi =======
E('btn-start-absen').onclick = ()=> startStream(vidAbsen);
E('btn-stop-absen').onclick = ()=> stopStream(vidAbsen);
E('btn-once-absen').onclick = absenOnce;

async function absenOnce(){
  if(!vidAbsen.srcObject){ alert('Nyalakan kamera dulu.'); return; }
  const dets = await faceapi.detectAllFaces(vidAbsen, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
  if(!dets.length){ matchInfo.textContent = 'Hasil: -'; return; }
  dets.forEach(d=>{
    const m = faceMatcher.findBestMatch(d.descriptor);
    if(m.label !== 'unknown'){
      const student = students.find(s=> s.npm === m.label);
      const now = new Date().toLocaleString();
      attendance.push({ nama: student.nama, npm: student.npm, time: now });
      save(STORE.attendKey, attendance);
      renderAttendance();
      matchInfo.textContent = `Hasil: ${student.nama} ✅`;
      absenAlert.textContent = `${student.nama} (${student.npm}) berhasil absen!`;
      absenAlert.classList.remove('hidden');
      setTimeout(()=> absenAlert.classList.add('hidden'), 3000);
    } else {
      matchInfo.textContent = 'Hasil: Tidak dikenali ❌';
    }
  });
}
</script>
</body>
</html>
